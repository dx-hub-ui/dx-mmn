name: ci
on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

permissions:
  contents: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lockfile-guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (PR head if present)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.ref }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with: { version: 9 }

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install (allow lockfile update, monorepo)
        run: pnpm -r install --no-frozen-lockfile

      - name: Detect lockfile changes
        id: lockdiff
        run: |
          if git diff --quiet -- pnpm-lock.yaml; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Auto-commit updated lockfile (same-repo PRs)
        if: >
          steps.lockdiff.outputs.changed == 'true' &&
          github.event_name == 'pull_request' &&
          github.event.pull_request.head.repo.full_name == github.repository
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(ci): update pnpm-lock.yaml"
          file_pattern: pnpm-lock.yaml

      - name: Fail run if lockfile changed (forces re-run)
        if: steps.lockdiff.outputs.changed == 'true'
        run: |
          echo "::error ::pnpm-lock.yaml was updated. New commit must re-run CI."
          exit 1

  build:
    runs-on: ubuntu-latest
    needs: lockfile-guard
    if: ${{ always() && needs.lockfile-guard.result == 'success' }}
    env:
      CI: "true"
      NEXT_TELEMETRY_DISABLED: "1"
      NEXT_PUBLIC_SUPABASE_URL: "https://placeholder.supabase.co"
      NEXT_PUBLIC_SUPABASE_ANON_KEY: "placeholder-anon-key"
      NEXT_PUBLIC_SENTRY_DSN: "https://examplePublicKey@o000000.ingest.sentry.io/000000"
      NEXT_PUBLIC_POSTHOG_KEY: "phc_placeholder_key"
      NEXT_PUBLIC_POSTHOG_HOST: "https://app.posthog.com"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with: { version: 9 }

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install (strict, monorepo)
        run: pnpm -r install --frozen-lockfile

      # - name: Prisma generate
      #   run: pnpm -r exec prisma generate

      - name: Build all workspaces
        run: pnpm -r build
